<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Books Table</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1 class="mt-5 mb-4">Books</h1>
        <div class="container">
            <input type="hidden" id="bookId"/>
            <div class="form-group">
                <label for="bookName">Назва книги:</label>
                <input id="bookName" class="form-control" />
            </div>
            <div class="form-group">
                <label for="bookYear">Рік:</label>
                <input id="bookYear" class="form-control" type="number" />
            </div>
            <div class="form-group">
                <label for="bookQuantity">Кількість книг:</label>
                <input id="bookQuantity" class="form-control" type="number" />
            </div>
            <div class="form-group">
                <label for="bookCategory">Категорія книги:</label>
                <input id="bookCategory" class="form-control" type="number" />
            </div>
            <div class="form-group">
                <label for="bookAuthor">Автор книги:</label>
                <input id="bookAuthor" class="form-control" type="number" />
            </div>
            <div class="form-group">
                <button id="saveBtn" class="btn btn-primary">Зберегти</button>
                <button id="resetBtn" class="btn btn-secondary">Скинути</button>
            </div>
        </div>

        <table class="table table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Year</th>
                    <th>Available</th>
                    <th>Category</th>
                    <th>Author</th>
                    <th>Edit</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                {% block content %}
                {% for book in books %}
                    <tr>
                        <td>{{ book.id }}</td>
                        <td>{{ book.nameBook }}</td>
                        <td>{{ book.yearBook }}</td>
                        <td>{{ book.availableBook }}</td>
                        <td>{{ book.categories.nameCategory }}</td>
                        <td>{{ book.author.nameAuthor }}</td>
                        <td><button onclick="getBook({{ book.id }})" class="btn btn-secondary">Edit</button></td> 
                        <td><button onclick="deleteBook({{ book.id }})" class="btn btn-danger">Delete</button></td>          
                    </tr>
                {% endfor %}
                {% endblock %}
            </tbody>
        </table>    
    </div>
</body>
<script>
    async function getBook(id) {
        const response = await fetch(`/book/${id}`, {        
        method: "GET",
        headers: { "Accept": "application/json" }
        });
        if (response.ok === true) {
        const book = await response.json();
        document.getElementById("bookId").value = book.id;
        document.getElementById("bookYear").value = book.yearBook;
        document.getElementById("bookName").value = book.nameBook;
        document.getElementById("bookQuantity").value = book.availableBook;
        document.getElementById("bookCategory").value = book.category_id;
        document.getElementById("bookAuthor").value = book.author_id;
        }
        else {
        // якщо сталася помилка, отримуємо повідомлення про помилку
        const error = await response.json();
        console.log(error.message); // і виводимо його на консоль
        }
    }
    
    async function createBook(bookName, bookYear, bookQuantity, bookCategory, bookAuthor) {
        const response = await fetch("book", {
            method: "POST",
            headers: { "Accept": "application/json", "Content-Type": "application/json" },
            body: JSON.stringify({
                nameBook: bookName,
                yearBook: parseInt(bookYear, 10),
                availableBook: parseInt(bookQuantity, 10),
                category_id: parseInt(bookCategory, 10),
                author_id: parseInt(bookAuthor, 10)
            })
        });
        if (response.ok === true) {
            const user = await response.json();
            window.location.href = "book-list";
        } else {
            const error = await response.json();
            console.log(error.message);
        }
    }
    
    async function editBook(bookId, bookName, bookYear, bookQuantity, bookCategory, bookAuthor) {
        const response = await fetch("book", {
            method: "PUT",
            headers: { "Accept": "application/json", "Content-Type": "application/json" },
            body: JSON.stringify({
                id: bookId,
                nameBook: bookName,
                yearBook: parseInt(bookYear, 10),
                availableBook: parseInt(bookQuantity, 10),
                category_id: parseInt(bookCategory, 10),
                author_id: parseInt(bookAuthor, 10)
            })
        });
        if (response.ok === true) {
            const book = await response.json();
            window.location.href = "book-list";
        } else {
            const error = await response.json();
            console.log(error.message);
        }
    }
    // Видалення користувача
    async function deleteBook(id) {
    const response = await fetch(`/book/${id}`, {
    method: "DELETE",
    headers: { "Accept": "application/json" }
    });
    if (response.ok === true) {
    const book = await response.json();
    window.location.href = "book-list";
    }
    else {
    const error = await response.json();
    console.log(error.message);
    }
    }
    // скидання даних форми після відправлення
    function reset() {
        document.getElementById("bookId").value = 
        document.getElementById("bookName").value = 
        document.getElementById("bookYear").value = 
        document.getElementById("bookQuantity").value = 
        document.getElementById("bookCategory").value = 
        document.getElementById("bookAuthor").value = "";
    }
    // скидання значень форми
    document.getElementById("resetBtn").addEventListener("click", () => reset());
    // надсилання форми
    document.getElementById("saveBtn").addEventListener("click", async () => {
    const id = document.getElementById("bookId").value;
    const name = document.getElementById("bookName").value;
    const year = document.getElementById("bookYear").value;
    const quantity = document.getElementById("bookQuantity").value;
    const category = document.getElementById("bookCategory").value;
    const author = document.getElementById("bookAuthor").value;
    if (id === "")
        await createBook(name, year, quantity, category, author);
    else
        await editBook(id, name, year, quantity, category, author);
    reset();
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
</html>
